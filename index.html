<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaburwo Coffee Disease Detection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --rust: #B7410E;
            --canker: #8B4513;
            --healthy: #4CAF50;
            --nematodes: #9C27B0;
            --phoma: #FF9800;
            --mite: #F44336;
            --cescospora: #2196F3;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            min-height: 100vh;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #065f46, #047857);
        }
        
        .chat-bubble {
            border-radius: 20px;
            padding: 12px 18px;
            max-width: 80%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        
        .user-bubble {
            background: linear-gradient(135deg, #047857, #065f46);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .bot-bubble {
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 5px;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.75rem;
            align-items: start;
        }
        
        .preview-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }
        
        .preview-item img {
            width: 100%;
            height: 110px;
            object-fit: cover;
            border-radius: 0.75rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .preview-item:hover img {
            transform: scale(1.05);
        }
        
        .result-badge {
            font-size: 0.85rem;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
            text-align: center;
            min-height: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .spinner {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .upload-area {
            transition: all 0.3s ease;
            border: 2px dashed #a7f3d0;
            background-color: #f0fdf4;
        }
        
        .upload-area:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(5, 150, 105, 0.15);
            border-color: #047857;
            background-color: #ecfdf5;
        }
        
        .analyze-btn {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2);
            background: linear-gradient(135deg, #047857, #065f46);
        }
        
        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(5, 150, 105, 0.3);
            opacity: 0.95;
        }
        
        .analyze-btn:active {
            transform: translateY(1px);
        }
        
        .disease-tag {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .disease-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .cescospora { background-color: #dbeafe; color: #1d4ed8; }
        .canker { background-color: #ede9fe; color: #5b21b6; }
        .rust { background-color: #ffedd5; color: #9a3412; }
        .healthy { background-color: #dcfce7; color: #166534; }
        .nematodes { background-color: #f3e8fd; color: #7e22ce; }
        .phoma { background-color: #fffbeb; color: #a16207; }
        .mite { background-color: #fee2e2; color: #b91c1c; }
        
        .disease-description {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid #047857;
        }
        
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .disease-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .disease-card {
            border-radius: 0.75rem;
            padding: 1rem;
            transition: all 0.3s ease;
        }
        
        .disease-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .retry-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .retry-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
        }
        
        .cold-start-info {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <div id="connection-status" class="connection-status bg-yellow-100 text-yellow-800 hidden">
        <i class="fas fa-circle-notch fa-spin mr-2"></i> Connecting to model...
    </div>
    
    <header class="header-gradient text-white p-4 shadow-lg">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <div class="bg-white/20 p-2 rounded-full mr-3">
                    <i class="fas fa-seedling text-xl"></i>
                </div>
                <h1 class="text-2xl font-bold">Kaburwo Coffee Advisor</h1>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center bg-white/10 px-3 py-1 rounded-full">
                    <i class="fas fa-globe mr-2"></i>
                    <select id="language-selector" class="bg-transparent text-white py-1 focus:outline-none cursor-pointer">
                        <option value="en">English</option>
                        <option value="nd">Nandi</option>
                    </select>
                </div>
                <button class="bg-white/20 hover:bg-white/30 transition-colors p-2 rounded-full">
                    <i class="fas fa-user"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-1 container mx-auto py-6 px-4">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-xl overflow-hidden flex flex-col">
                <div class="p-4 border-b">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-comments text-emerald-600 mr-2"></i>
                        Coffee Chat Assistant
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Get expert advice</p>
                </div>
                
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                    </div>
                
                <div class="p-4 bg-white border-t">
                    <div class="flex items-center space-x-2">
                        <input id="chat-input" type="text" placeholder="Ask about coffee diseases..." 
                               class="flex-1 p-3 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-colors">
                        <button id="send-button" class="p-3 rounded-full text-white bg-gradient-to-r from-emerald-600 to-emerald-800 shadow-lg hover:opacity-90 transition-opacity">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-xl p-6 flex flex-col">
                <div class="pb-4 border-b">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-leaf text-emerald-600 mr-2"></i>
                        Coffee Disease Image Analysis
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Upload images of coffee leaves to detect diseases using our AI model</p>
                    
                    <div class="mt-3 flex items-center">
                        <div id="model-status" class="flex items-center">
                            <span class="w-3 h-3 rounded-full bg-gray-400 mr-2"></span>
                            <span class="text-sm">Model status: Checking...</span>
                        </div>
                        <button id="retry-connection" class="ml-4 text-sm text-emerald-600 hover:underline hidden">
                            <i class="fas fa-sync-alt mr-1"></i> Retry connection
                        </button>
                    </div>
                </div>
                
                <div id="connection-error" class="hidden mt-4 p-4 bg-red-50 rounded-lg border border-red-200">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-triangle text-red-500 mt-1 mr-3"></i>
                        <div>
                            <h3 class="font-bold text-red-700">Model Connection Failed</h3>
                            <p class="text-sm text-red-600 mt-1">
                                Unable to connect to the disease detection model. This could be due to:
                            </p>
                            <ul class="list-disc list-inside text-sm text-red-600 mt-2 pl-4">
                                <li>Server starting up (cold start on Render)</li>
                                <li>Model loading taking longer than expected</li>
                                <li>Network connectivity issues</li>
                            </ul>
                            <div class="mt-3">
                                <button id="retry-full" class="retry-btn">
                                    <i class="fas fa-sync-alt mr-2"></i> Retry Connection
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cold-start-info mt-4">
                        <h4 class="font-bold text-amber-800 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>
                            About Render Cold Starts
                        </h4>
                        <p class="text-sm text-amber-700 mt-2">
                            If you're using Render's free tier, your server might take 30-60 seconds to start up after 
                            being idle. This is normal behavior. The model will be available shortly.
                        </p>
                    </div>
                </div>
                
                <div id="analysis-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="border rounded-xl p-4 bg-gradient-to-br from-white to-emerald-50 shadow-sm">
                        <h3 class="font-semibold text-lg text-emerald-800 mb-3 flex items-center">
                            <i class="fas fa-image mr-2"></i>
                            Single Image Analysis
                        </h3>
                        
                        <div class="upload-area rounded-xl p-6 text-center cursor-pointer mb-4" id="image-upload-area-single">
                            <input type="file" id="image-upload" accept="image/*" class="hidden">
                            <div id="image-preview" class="hidden">
                                <img alt="Uploaded photo" class="max-h-64 mx-auto rounded-lg shadow-md">
                            </div>
                            <div id="image-upload-placeholder" class="flex flex-col items-center">
                                <i class="fas fa-cloud-upload-alt text-emerald-500 text-4xl mb-3"></i>
                                <span class="text-emerald-700 font-medium">Upload a single coffee leaf image</span>
                                <span class="text-emerald-500 text-sm mt-1">Click to browse files</span>
                            </div>
                        </div>
                        
                        <button id="analyze-button" class="analyze-btn w-full py-3 rounded-full text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-search mr-2"></i> Analyze with Model
                        </button>
                        
                        <div id="analysis-result" class="hidden mt-4 p-4 bg-emerald-50 rounded-lg border border-emerald-100">
                            <h3 class="font-bold text-emerald-800 mb-2 flex items-center">
                                <i class="fas fa-clipboard-list mr-2"></i>
                                Analysis Results:
                            </h3>
                            <div id="analysis-text" class="text-gray-700"></div>
                        </div>
                    </div>
                    
                    <div class="border rounded-xl p-4 bg-gradient-to-br from-white to-blue-50 shadow-sm">
                        <h3 class="font-semibold text-lg text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-layer-group mr-2"></i>
                            Batch Image Analysis
                        </h3>
                        
                        <div class="mb-4">
                            <div class="upload-area rounded-xl p-4 text-center cursor-pointer mb-3" id="image-upload-area-multi">
                                <input type="file" id="image-upload-multi" accept="image/*" multiple class="hidden">
                                <div class="flex flex-col items-center py-4">
                                    <i class="fas fa-images text-blue-500 text-3xl mb-2"></i>
                                    <span class="text-blue-700 font-medium">Upload multiple coffee leaf images</span>
                                    <span class="text-blue-500 text-sm mt-1">Click to browse files</span>
                                </div>
                            </div>
                            
                            <div id="preview-grid-multi" class="preview-grid mt-3 hidden"></div>
                        </div>
                        
                        <button id="analyze-button-multi" class="analyze-btn w-full py-3 rounded-full text-white font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-tasks mr-2"></i> Analyze All with Model
                        </button>
                        
                        <div id="analysis-result-multi" class="hidden mt-4 p-4 bg-blue-50 rounded-lg border border-blue-100 max-h-60 overflow-y-auto">
                            <h3 class="font-bold text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-list-check mr-2"></i>
                                Batch Results
                            </h3>
                            <div id="analysis-text-multi" class="text-sm text-gray-700"></div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8 pt-4 border-t">
                    <h3 class="font-semibold text-lg text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-book-medical mr-2 text-emerald-600"></i>
                        Coffee Disease Guide
                    </h3>
                    <div class="disease-grid">
                        <div class="disease-card cescospora">
                            <div class="font-bold text-lg disease-tag cescospora">Cercospora Leaf Spot</div>
                            <p class="text-sm mt-2">Fungal infection causing small, dark spots on leaves that can merge into larger lesions.</p>
                        </div>
                        <div class="disease-card canker">
                            <div class="font-bold text-lg disease-tag canker">Coffee Canker</div>
                            <p class="text-sm mt-2">Bacterial disease causing sunken lesions on stems and branches, leading to dieback.</p>
                        </div>
                        <div class="disease-card rust">
                            <div class="font-bold text-lg disease-tag rust">Coffee Leaf Rust</div>
                            <p class="text-sm mt-2">Fungal disease causing orange powdery spots on leaves. Reduces photosynthesis and yield.</p>
                        </div>
                        <div class="disease-card healthy">
                            <div class="font-bold text-lg disease-tag healthy">Healthy</div>
                            <p class="text-sm mt-2">Normal coffee plant with vibrant green leaves and no signs of disease or stress.</p>
                        </div>
                        <div class="disease-card nematodes">
                            <div class="font-bold text-lg disease-tag nematodes">Nematodes</div>
                            <p class="text-sm mt-2">Microscopic worms attacking roots, causing stunted growth and reduced nutrient uptake.</p>
                        </div>
                        <div class="disease-card phoma">
                            <div class="font-bold text-lg disease-tag phoma">Phoma Leaf Spot</div>
                            <p class="text-sm mt-2">Fungal disease causing irregular brown spots with yellow halos on leaves.</p>
                        </div>
                        <div class="disease-card mite">
                            <div class="font-bold text-lg disease-tag mite">Red Spider Mite</div>
                            <p class="text-sm mt-2">Tiny pests causing yellow stippling on leaves, leading to defoliation in severe cases.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center space-x-6 mb-4">
                <a href="#" class="hover:text-emerald-400 transition-colors"><i class="fab fa-github"></i></a>
                <a href="#" class="hover:text-emerald-400 transition-colors"><i class="fab fa-twitter"></i></a>
                <a href="#" class="hover:text-emerald-400 transition-colors"><i class="fab fa-facebook"></i></a>
                <a href="#" class="hover:text-emerald-400 transition-colors"><i class="fab fa-instagram"></i></a>
            </div>
            <p class="text-sm text-gray-400">Â© 2023 Kaburwo Coffee Disease Detection. All rights reserved.</p>
            <p class="text-xs text-gray-500 mt-2">Accurately detecting all 7 coffee disease classes</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const chatMessages = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const languageSelector = document.getElementById('language-selector');
            const modelStatus = document.getElementById('model-status');
            const retryButton = document.getElementById('retry-connection');
            const retryFullButton = document.getElementById('retry-full');
            const connectionStatus = document.getElementById('connection-status');
            const connectionError = document.getElementById('connection-error');
            const analysisSection = document.getElementById('analysis-section');
            
            // Single image elements
            const imageUpload = document.getElementById('image-upload');
            const imageUploadAreaSingle = document.getElementById('image-upload-area-single');
            const imagePreview = document.getElementById('image-preview');
            const imageUploadPlaceholder = document.getElementById('image-upload-placeholder');
            const analyzeButton = document.getElementById('analyze-button');
            const analysisResult = document.getElementById('analysis-result');
            const analysisText = document.getElementById('analysis-text');
            const imagePreviewImg = imagePreview.querySelector('img');
            
            // Multi image elements
            const imageUploadMulti = document.getElementById('image-upload-multi');
            const imageUploadAreaMulti = document.getElementById('image-upload-area-multi');
            const previewGridMulti = document.getElementById('preview-grid-multi');
            const analyzeButtonMulti = document.getElementById('analyze-button-multi');
            const analysisResultMulti = document.getElementById('analysis-result-multi');
            const analysisTextMulti = document.getElementById('analysis-text-multi');
            
            // State variables
            let language = 'en';
            let uploadedImageFile = null;
            let uploadedFilesMulti = [];
            let modelAvailable = false;
            
            // Language-specific content
            // The initialMessages object has been removed since the message is already added dynamically.
            const localResponses = {
                en: {
                    chlorosis: {
                        triggers: ['what causes coffee leaves to turn yellow?', 'yellow leaves', 'why are my coffee leaves yellow?', 'leaves turning yellow'],
                        response: 'Disease/Condition Name: **Chlorosis**. Description: Chlorosis is a condition where leaves don\'t produce enough chlorophyll, the green pigment that helps the plant make food. This is usually caused by a **lack of nutrients**, poor soil drainage, or over-watering. Symptoms: Look for leaves that are entirely pale yellow or have green veins with yellow between them. Treatment: Check your soil drainage and consider using a balanced fertilizer that contains micronutrients like iron and magnesium.',
                    },
                    anthracnose: {
                        triggers: ['why are there black spots on my coffee cherries?', 'black spots on cherries', 'what are the black spots on my coffee?'],
                        response: 'Disease/Condition Name: **Anthracnose**. Description: This is a fungal disease that causes sunken black spots on coffee cherries, leaves, and stems. It can cause cherries to drop prematurely. Symptoms: Dark, sunken lesions on cherries, often with a ring pattern. Treatment: Prune and destroy affected parts of the plant. Apply a copper-based fungicide, and ensure the plants have good air circulation.',
                    },
                    wilting: {
                        triggers: ['what does it mean if the leaves are curling or wilting?', 'leaves are wilting', 'curling leaves', 'drooping leaves'],
                        response: 'Disease/Condition Name: **Root Rot or Water Stress**. Description: Leaf curling and wilting are often symptoms of either a lack of water (water stress) or too much water, which leads to Root Rot. Root Rot is a fungal disease that damages the roots, preventing them from absorbing water and nutrients. Symptoms: Leaves curl inward, droop, and may turn brown. The plant may appear weak and yellow. Treatment: If the soil is dry, water thoroughly. If the soil is waterlogged, improve drainage. You may need to remove and replant the tree if the root damage is severe.',
                    },
                    low_yield: {
                        triggers: ['my coffee plant is not producing many cherries. what could be the problem?', 'low coffee production', 'few cherries on my tree', 'not many cherries'],
                        response: 'Disease/Condition Name: **Poor Pollination or Nutrient Deficiency**. Description: Low cherry production can be due to several factors. It could be poor pollination, a lack of essential nutrients like potassium and phosphorus, or incorrect pruning that removes new growth. Symptoms: Few flowers or cherries on the tree. Treatment: Ensure there are enough pollinators (e.g., bees). Use a fertilizer high in potassium and phosphorus. Follow a proper pruning schedule to encourage new, fruit-bearing branches.',
                    },
                },
                nd: {
                    chlorosis: {
                        triggers: ['tos nee neyae sokeekab kawek koek pisalyaa/bisaliin?', 'bisalyaa sokeek', 'pisaliik sakeek', 'bisaliin sokeek'],
                        response: 'Myondo: **chlorosis** ako imuchi koek kabarunetab myando kityo. Tagunet: chlorosis kotakunee sakeek che makonyalileen kou ole maktaat kotugu. Kito ne yae kobiit chlorosis ko rerunetab keturek anan makutiikab kawek eng ng\'ung\'unyeek. Kabarunoiik che konin inai ile chlorosis: Ngotko nyalileen tikitik chebo sokeek lakini bisalyaa kimasta ake, ngotkowalak sokot komugul koek bisalyaa. Kanyaiseet: Riib beek matkotolil eng kapkelyenuutab minutik, machei kora ketes keturek che imuche kotes iron ak magnesium',
                    },
                    anthracnose: {
                        triggers: ['tos nee neyaei kosich matundekab kawek tukun che tuen?', 'konam tukun che tuen logoeek', 'tuen logoek', 'tindoi tugun che tuen', 'kotuekitu'],
                        response: 'Myondo:**Anthracnose**. Tagunet: ikerei tisonook che tueen eng logoekab kawek anan ko eng sakekab kawek anan ko ketit nebo kawek kora. Yaei myoni kobutyo logoekab kawek kora eng ketit amakonyo. Kabarunoik:tisook chetueen chemii logoek ako chopei kiy neu maringoit. Kanyaiseet:til kimasweek tugul che katiny myondo akiwirte. Kararan keisto ketinotok tugul ak kekol ake netili. Kinfoi kericheck chetindoi coper. Akichop mbaret kolapkeiit asi komuut koristo ne tilil minutik.',
                    },
                },
            };
            
            // Your model's class labels
            const modelClasses = [
                "cescospora_leaf_sport",
                "coffee_canker",
                "coffee_leaf_rust",
                "healthy",
                "nematodes",
                "phoma_leaf_sport",
                "red_spider_mite"
            ];
            
            // Check model connection with retry logic
            async function checkModelConnection() {
                connectionStatus.classList.remove('hidden');
                connectionStatus.className = "connection-status bg-yellow-100 text-yellow-800";
                connectionStatus.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Connecting to model...';
                
                // Try multiple times to account for cold starts
                let attempts = 0;
                const maxAttempts = 5;
                let connected = false;
                
                while (attempts < maxAttempts && !connected) {
                    try {
                        const response = await fetch('/health');
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.status === "available") {
                                modelStatus.innerHTML = '<span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span><span class="text-sm">Model status: Connected and ready</span>';
                                connectionStatus.className = "connection-status bg-green-100 text-green-800";
                                connectionStatus.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Model connected successfully!';
                                modelAvailable = true;
                                retryButton.classList.add('hidden');
                                connectionError.classList.add('hidden');
                                analysisSection.classList.remove('hidden');
                                connected = true;
                            } else {
                                throw new Error(data.message || 'Model not ready');
                            }
                        } else {
                            throw new Error('Health check failed');
                        }
                    } catch (error) {
                        attempts++;
                        if (attempts < maxAttempts) {
                            // Wait 2 seconds before next attempt
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        }
                    }
                }
                
                if (!connected) {
                    // If all attempts fail
                    modelStatus.innerHTML = '<span class="w-3 h-3 rounded-full bg-red-500 mr-2"></span><span class="text-sm">Model status: Connection failed</span>';
                    connectionStatus.className = "connection-status bg-red-100 text-red-800";
                    connectionStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i> Could not connect to model.';
                    retryButton.classList.remove('hidden');
                    connectionError.classList.remove('hidden');
                    modelAvailable = false;
                    analyzeButton.disabled = true;
                    analyzeButtonMulti.disabled = true;
                }
                
                setTimeout(() => {
                    connectionStatus.classList.add('hidden');
                }, 5000); // Hide status message after 5 seconds
            }

            // Function to add a message to the chat
            function addMessage(text, sender) {
                const messageElement = document.createElement('div');
                messageElement.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'bot-bubble'}`;
                bubble.innerHTML = text; // Use innerHTML to allow for bolding
                
                messageElement.appendChild(bubble);
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll to the latest message
            }

            // Handle user chat messages
            function handleUserMessage() {
                const message = chatInput.value.trim();
                if (message === '') return;
                
                addMessage(message, 'user');
                chatInput.value = '';
                
                let foundResponse = false;
                for (const key in localResponses[language]) {
                    const triggers = localResponses[language][key].triggers;
                    for (const trigger of triggers) {
                        if (message.toLowerCase().includes(trigger)) {
                            setTimeout(() => {
                                addMessage(localResponses[language][key].response, 'bot');
                            }, 500); // Simulate a small delay
                            foundResponse = true;
                            break;
                        }
                    }
                    if (foundResponse) break;
                }
                
                if (!foundResponse) {
                    setTimeout(() => {
                        const defaultResponse = language === 'en'
                            ? "I'm sorry, I don't have information on that specific topic. Please try asking about common coffee plant diseases or upload an image for analysis."
                            : "Maamuteet, mamii tebutok eng chiitok. Oretet kora myanwogikab kawek che kaimut kot otebechi kora ng'ot otebechi kora myanwogikab kapek che kiyoo. Ingoi kiy kogomuchi keeetut. Oretet kora ak image nebo sokeet neo kotogoi."
                        addMessage(defaultResponse, 'bot');
                    }, 500);
                }
            }

            // Event listeners for chat
            sendButton.addEventListener('click', handleUserMessage);
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleUserMessage();
                }
            });
            
            // Language selector
            languageSelector.addEventListener('change', function() {
                language = this.value;
                // Add an initial greeting message based on the selected language
                const initialGreeting = language === 'en'
                    ? "Hello! I'm your coffee disease expert. How can I help you?"
                    : "Takwenya! Anendet ng'amotioot nebo kawek. Tos mii kiy ne imeche atoretin rani?";
                
                chatMessages.innerHTML = ''; // Clear previous messages
                addMessage(initialGreeting, 'bot');
            });
            
            // Single image upload logic
            imageUploadAreaSingle.addEventListener('click', () => {
                imageUpload.click();
            });
            
            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    uploadedImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreviewImg.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        imageUploadPlaceholder.classList.add('hidden');
                        if (modelAvailable) {
                            analyzeButton.disabled = false;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Batch image upload logic
            imageUploadAreaMulti.addEventListener('click', () => {
                imageUploadMulti.click();
            });
            
            imageUploadMulti.addEventListener('change', (event) => {
                uploadedFilesMulti = Array.from(event.target.files);
                if (uploadedFilesMulti.length > 0) {
                    previewGridMulti.innerHTML = '';
                    previewGridMulti.classList.remove('hidden');
                    
                    uploadedFilesMulti.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const previewItem = document.createElement('div');
                            previewItem.className = 'preview-item';
                            previewItem.innerHTML = `<img src="${e.target.result}" alt="Uploaded photo" class="w-full h-24 object-cover rounded-lg shadow-md">
                                                     <div class="result-badge bg-gray-200 text-gray-800">Pending</div>`;
                            previewGridMulti.appendChild(previewItem);
                        };
                        reader.readAsDataURL(file);
                    });
                    
                    if (modelAvailable) {
                        analyzeButtonMulti.disabled = false;
                    }
                }
            });
            
            // Analyze single image
            analyzeButton.addEventListener('click', async () => {
                if (!uploadedImageFile || !modelAvailable) return;
                
                analyzeButton.innerHTML = '<span class="spinner mr-2"></span> Analyzing...';
                analyzeButton.disabled = true;
                
                const formData = new FormData();
                formData.append('file', uploadedImageFile);
                
                try {
                    const response = await fetch('/predict', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        const prediction = data.prediction;
                        const confidence = (data.confidence * 100).toFixed(2);
                        
                        let formattedPrediction = prediction.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        
                        let diseaseDescription = "No information found for this disease.";
                        
                        // Find the corresponding disease description from the static guide
                        const diseaseGuideCards = document.querySelectorAll('.disease-card');
                        diseaseGuideCards.forEach(card => {
                            const tag = card.querySelector('.disease-tag');
                            if (tag && tag.textContent.trim().toLowerCase() === formattedPrediction.toLowerCase()) {
                                const description = card.querySelector('p').textContent;
                                diseaseDescription = `**${formattedPrediction}**: ${description}`;
                            }
                        });
                        
                        analysisText.innerHTML = `
                            <p><b>Prediction:</b> <span class="font-bold text-lg text-emerald-600">${formattedPrediction}</span></p>
                            <p class="text-sm text-gray-500">Confidence: ${confidence}%</p>
                            <div class="mt-2 text-gray-700">
                                <h4 class="font-bold">Description:</h4>
                                <p class="mt-1">${diseaseDescription}</p>
                            </div>
                        `;
                        analysisResult.classList.remove('hidden');
                    } else {
                        analysisText.textContent = `Error: ${data.error || 'Prediction failed.'}`;
                        analysisResult.classList.remove('hidden');
                    }
                } catch (error) {
                    analysisText.textContent = `Connection error: ${error.message}`;
                    analysisResult.classList.remove('hidden');
                } finally {
                    analyzeButton.innerHTML = '<i class="fas fa-search mr-2"></i> Analyze with Model';
                    analyzeButton.disabled = !modelAvailable;
                }
            });
            
            // Analyze multiple images
            analyzeButtonMulti.addEventListener('click', async () => {
                if (uploadedFilesMulti.length === 0 || !modelAvailable) return;
                
                analyzeButtonMulti.innerHTML = '<span class="spinner mr-2"></span> Analyzing All...';
                analyzeButtonMulti.disabled = true;
                
                analysisTextMulti.innerHTML = '';
                analysisResultMulti.classList.remove('hidden');
                
                for (let i = 0; i < uploadedFilesMulti.length; i++) {
                    const file = uploadedFilesMulti[i];
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const previewItem = previewGridMulti.children[i];
                    const resultBadge = previewItem.querySelector('.result-badge');
                    
                    resultBadge.textContent = 'Analyzing...';
                    resultBadge.className = 'result-badge bg-yellow-200 text-yellow-800';
                    
                    try {
                        const response = await fetch('/predict', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            const prediction = data.prediction;
                            const confidence = (data.confidence * 100).toFixed(2);
                            
                            let formattedPrediction = prediction.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                            
                            // Update the badge
                            let badgeClass = 'bg-gray-200 text-gray-800';
                            if (prediction === 'healthy') badgeClass = 'bg-green-200 text-green-800';
                            else if (prediction === 'coffee_leaf_rust') badgeClass = 'bg-yellow-200 text-yellow-800';
                            else badgeClass = 'bg-red-200 text-red-800';
                            
                            resultBadge.textContent = formattedPrediction;
                            resultBadge.className = `result-badge ${badgeClass}`;
                            
                            analysisTextMulti.innerHTML += `
                                <div class="p-2 border-b last:border-b-0">
                                    <p class="font-semibold text-gray-800">Image ${i + 1}: ${formattedPrediction}</p>
                                    <p class="text-xs text-gray-500">Confidence: ${confidence}%</p>
                                </div>
                            `;
                        } else {
                            resultBadge.textContent = 'Error';
                            resultBadge.className = 'result-badge bg-red-200 text-red-800';
                            analysisTextMulti.innerHTML += `<p class="text-sm p-2 text-red-600">Image ${i + 1}: Error - ${data.error || 'Prediction failed.'}</p>`;
                        }
                    } catch (error) {
                        resultBadge.textContent = 'Error';
                        resultBadge.className = 'result-badge bg-red-200 text-red-800';
                        analysisTextMulti.innerHTML += `<p class="text-sm p-2 text-red-600">Image ${i + 1}: Connection Error</p>`;
                    }
                }
                
                analyzeButtonMulti.innerHTML = '<i class="fas fa-tasks mr-2"></i> Analyze All with Model';
                analyzeButtonMulti.disabled = !modelAvailable;
            });

            // Initial check
            checkModelConnection();
            retryButton.addEventListener('click', checkModelConnection);
            retryFullButton.addEventListener('click', checkModelConnection);

            // Initial message
            const initialGreeting = language === 'en'
                ? "Hello! I'm your coffee disease expert. How can I help you today?"
                : "Takwenya! Anendet ng'amotioot nebo kawek. Tos mii kiy ne imeche atoretin rani?";
            addMessage(initialGreeting, 'bot');
        });
    </script>
</body>
</html>
